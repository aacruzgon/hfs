name: HFS Extended CI (Beta/Nightly)

on:
  schedule:
    # Run nightly at 2am Eastern (7am UTC) on weekdays
    - cron: '0 7 * * 1-5'
  workflow_dispatch:  # Allow manual trigger too

env:
  CARGO_TERM_COLOR: always
  CARGO_BUILD_JOBS: 1
  CARGO_PROFILE_DEV_DEBUG: 0
  DOCKER_HOST: ${{ secrets.DOCKER_HOST }}

jobs:
  test-rust:
    name: Test Rust (${{ matrix.rust }})
    runs-on: [self-hosted, Linux]
    strategy:
      fail-fast: false
      matrix:
        rust: [beta, nightly]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: false
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}
      - name: Configure LLD
        run: |
          mkdir -p ~/.cargo
          rm -f ~/.cargo/config.toml
          echo '[target.x86_64-unknown-linux-gnu]' >> ~/.cargo/config.toml
          echo 'linker = "clang"' >> ~/.cargo/config.toml
          echo 'rustflags = ["-C", "link-arg=-fuse-ld=lld", "-C", "link-arg=-Wl,-zstack-size=8388608"]' >> ~/.cargo/config.toml
      - name: Run tests
        run: cargo test --workspace --all-features

  cleanup-test-containers:
    name: Cleanup Test Containers
    runs-on: [self-hosted, Linux]
    needs: [test-rust]
    if: always()
    steps:
      - name: Remove testcontainers from this run
        run: |
          docker ps -aq --filter "label=github.run_id=${{ github.run_id }}" | xargs -r docker rm -f || true

name: HFS Continuous Delivery

on:
  release:
    types: [published]

jobs:
  deploy:
    name: Deploy to server
    runs-on: [self-hosted, Linux] 
    
    steps:
    - name: Download release binary
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const { data: release } = await github.rest.repos.getReleaseByTag({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag: context.ref.replace('refs/tags/', '')
          });
          
          // Find the Linux binary (adjust the pattern as needed)
          const asset = release.assets.find(asset => 
            asset.name.includes('x86_64-unknown-linux-gnu') && 
            asset.name.endsWith('.tar.gz')
          );
          
          if (!asset) {
            throw new Error('Linux binary not found in release assets');
          }
          
          const { data } = await github.rest.repos.getReleaseAsset({
            owner: context.repo.owner,
            repo: context.repo.repo,
            asset_id: asset.id,
            headers: {
              Accept: 'application/octet-stream'
            }
          });
          
          fs.writeFileSync('release-binary.tar.gz', Buffer.from(data));
          console.log(`Downloaded: ${asset.name}`);

    - name: Extract binary
      run: |
        tar -xzf release-binary.tar.gz
        chmod +x ${{ github.event.repository.name }}
        
    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        script: |
          # Create deployment directory
          sudo mkdir -p /opt/${{ github.event.repository.name }}
          
          # Stop existing service (if running)
          sudo systemctl stop ${{ github.event.repository.name }} || true
          
          # Backup current version
          sudo cp /opt/${{ github.event.repository.name }}/${{ github.event.repository.name }} \
             /opt/${{ github.event.repository.name }}/${{ github.event.repository.name }}.backup || true

    - name: Upload new binary
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        source: ${{ github.event.repository.name }}
        target: /tmp/

    - name: Install and start service
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        script: |
          # Move binary to final location
          sudo mv /tmp/${{ github.event.repository.name }} /opt/${{ github.event.repository.name }}/
          sudo chown root:root /opt/${{ github.event.repository.name }}/${{ github.event.repository.name }}
          sudo chmod +x /opt/${{ github.event.repository.name }}/${{ github.event.repository.name }}
          
          # Create systemd service file if it doesn't exist
          if [ ! -f /etc/systemd/system/${{ github.event.repository.name }}.service ]; then
            sudo tee /etc/systemd/system/${{ github.event.repository.name }}.service > /dev/null <<EOF
          [Unit]
          Description=${{ github.event.repository.name }} service
          After=network.target
          
          [Service]
          Type=simple
          User=nobody
          Group=nogroup
          ExecStart=/opt/${{ github.event.repository.name }}/${{ github.event.repository.name }}
          Restart=always
          RestartSec=5
          
          [Install]
          WantedBy=multi-user.target
          EOF
            sudo systemctl daemon-reload
            sudo systemctl enable ${{ github.event.repository.name }}
          fi
          
          # Start the service
          sudo systemctl start ${{ github.event.repository.name }}
          sudo systemctl status ${{ github.event.repository.name }}

    - name: Verify deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        script: |
          # Wait a moment for service to start
          sleep 5
          
          # Check if service is running
          if sudo systemctl is-active --quiet ${{ github.event.repository.name }}; then
            echo "✅ Deployment successful - service is running"
            sudo systemctl status ${{ github.event.repository.name }}
          else
            echo "❌ Deployment failed - service is not running"
            sudo journalctl -u ${{ github.event.repository.name }} --lines=20
            exit 1
          fi

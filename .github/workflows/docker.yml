name: Docker Images

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'CI workflow run ID that produced the release artifacts (numeric ID from the CI run)'
        required: true
        type: string

permissions:
  contents: read
  packages: write
  actions: read

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/heliossoftware
  DOCKER_HOST: ${{ secrets.DOCKER_HOST }}

jobs:
  build-images:
    name: Build ${{ matrix.image }} (${{ matrix.arch }})
    runs-on: [self-hosted, Linux]
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       startsWith(github.event.workflow_run.head_branch, 'v'))
    strategy:
      fail-fast: false
      matrix:
        image:
          - hfs
          - fhirpath-server
          - sof-server
        arch:
          - amd64
          - arm64
        include:
          - image: hfs
            binary: hfs
            port: 8080
            include_data: true
          - image: fhirpath-server
            binary: fhirpath-server
            port: 3000
            include_data: false
          - image: sof-server
            binary: sof-server
            port: 8080
            include_data: false
          - arch: amd64
            rust_target: x86_64-unknown-linux-gnu
            artifact_release_dir: target/release
          - arch: arm64
            rust_target: aarch64-unknown-linux-gnu
            artifact_release_dir: target/aarch64-unknown-linux-gnu/release
    steps:
      - name: Checkout (for Dockerfile)
        uses: actions/checkout@v4

      - name: Determine source run ID
        id: source
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "run_id=${{ inputs.run_id }}" >> "$GITHUB_OUTPUT"
          else
            echo "run_id=${{ github.event.workflow_run.id }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Determine version tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Fetch the tag from the source run
            TAG=$(gh run view "${{ steps.source.outputs.run_id }}" --repo "${{ github.repository }}" --json headBranch -q '.headBranch')
          else
            TAG="${{ github.event.workflow_run.head_branch }}"
          fi
          # Strip leading 'v' for semver
          VERSION="${TAG#v}"
          MAJOR_MINOR="${VERSION%.*}"
          SHA="$(gh run view "${{ steps.source.outputs.run_id }}" --repo "${{ github.repository }}" --json headSha -q '.headSha' | head -c 8)"
          IS_PRERELEASE=$( [[ "$VERSION" == *-* ]] && echo true || echo false )

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "major_minor=$MAJOR_MINOR" >> "$GITHUB_OUTPUT"
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"
          echo "is_prerelease=$IS_PRERELEASE" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Download CI artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          run_id: ${{ steps.source.outputs.run_id }}
          name: hfs-${{ matrix.rust_target }}
          path: ./artifact

      - name: Prepare Docker build context
        run: |
          mkdir -p docker-context
          cp artifact/${{ matrix.artifact_release_dir }}/${{ matrix.binary }} docker-context/
          if [ "${{ matrix.include_data }}" = "true" ]; then
            cp -r artifact/data docker-context/data
          fi

      - name: Set up QEMU (for cross-arch builds)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push (${{ matrix.arch }})
        uses: docker/build-push-action@v6
        with:
          context: docker-context
          file: Dockerfile
          platforms: linux/${{ matrix.arch }}
          push: true
          build-args: |
            BINARY_NAME=${{ matrix.binary }}
            EXPOSE_PORT=${{ matrix.port }}
          tags: ${{ env.IMAGE_PREFIX }}/${{ matrix.image }}:${{ steps.version.outputs.version }}-${{ matrix.arch }}

  push-manifests:
    name: Push manifest (${{ matrix.image }})
    runs-on: [self-hosted, Linux]
    needs: [build-images]
    strategy:
      matrix:
        image:
          - hfs
          - fhirpath-server
          - sof-server
    steps:
      - name: Determine version tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG=$(gh run view "${{ inputs.run_id }}" --repo "${{ github.repository }}" --json headBranch -q '.headBranch')
            SHA=$(gh run view "${{ inputs.run_id }}" --repo "${{ github.repository }}" --json headSha -q '.headSha' | head -c 8)
          else
            TAG="${{ github.event.workflow_run.head_branch }}"
            SHA="${{ github.event.workflow_run.head_sha }}"
            SHA="${SHA:0:8}"
          fi
          VERSION="${TAG#v}"
          MAJOR_MINOR="${VERSION%.*}"
          IS_PRERELEASE=$( [[ "$VERSION" == *-* ]] && echo true || echo false )

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "major_minor=$MAJOR_MINOR" >> "$GITHUB_OUTPUT"
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"
          echo "is_prerelease=$IS_PRERELEASE" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push multi-arch manifest
        run: |
          IMAGE="${{ env.IMAGE_PREFIX }}/${{ matrix.image }}"
          VERSION="${{ steps.version.outputs.version }}"
          MAJOR_MINOR="${{ steps.version.outputs.major_minor }}"
          SHA="${{ steps.version.outputs.sha }}"

          # Build tag list
          TAGS="-t ${IMAGE}:${VERSION} -t ${IMAGE}:${MAJOR_MINOR} -t ${IMAGE}:sha-${SHA}"

          # Add :latest only for non-prerelease
          if [ "${{ steps.version.outputs.is_prerelease }}" = "false" ]; then
            TAGS="${TAGS} -t ${IMAGE}:latest"
          fi

          docker buildx imagetools create \
            ${TAGS} \
            "${IMAGE}:${VERSION}-amd64" \
            "${IMAGE}:${VERSION}-arm64"
